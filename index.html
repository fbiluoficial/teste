<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-do-ADM com IA</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/mHq3ADF/to-do-list.png">
    <style>
        /* --- GERAL E TEMA --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --surface-hover-color: #2a2a2a;
            --font-color: #e0e0e0;
            --border-color: #333;
            --primary-accent: #0d6efd;
            --primary-accent-hover: #0b5ed7;
            
            --status-aberto: #ffc107;
            --status-andamento: #0d6efd;
            --status-finalizado: #198754;
            --status-aguardando: #6f42c1;

            --priority-alta: #dc3545;
            --priority-media: #ffc107;
            --priority-baixa: #198754;

            --google-blue: #4285F4;
            --google-red: #DB4437;
            --google-yellow: #F4B400;
            --google-green: #0F9D58;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            padding-top: 60px; /* Espaço para o cabeçalho fixo */
            overflow-x: hidden;
        }

        /* --- CABEÇALHO E MENU SUPERIOR --- */
        header {
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            gap: 15px;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-accent);
        }

        .menu-button, .menu-item select, .menu-item input[type="text"] {
            background-color: var(--surface-color);
            color: var(--font-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-size: 14px;
        }
        .menu-button:hover, .menu-item select:hover { 
            background-color: var(--surface-hover-color);
            border-color: var(--primary-accent);
        }
        
        /* --- Dropdown Menu --- */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--surface-color);
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            right: 0; /* Alinha o dropdown de configurações à direita */
        }
        .dropdown-content .dropdown-item {
            color: var(--font-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        .dropdown-content .dropdown-item:hover { background-color: var(--surface-hover-color); }
        .show { display: block; }

        /* Notificações */
        #notificationBtn {
            position: relative;
        }
        #notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--priority-alta);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--surface-color);
        }
        #notification-list {
            max-height: 400px;
            overflow-y: auto;
            min-width: 300px;
        }
        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item:hover {
            background-color: var(--surface-hover-color);
        }
        .notification-info {
            flex-grow: 1;
            margin-right: 10px;
        }
        .notification-item p {
            margin: 0 0 2px 0;
            font-size: 0.9em;
        }
        .notification-item small {
            color: #aaa;
        }
        
        /* --- Pesquisa com IA --- */
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #searchInput.ai-active {
            border-color: transparent;
            background-image: linear-gradient(var(--surface-color), var(--surface-color)), 
                              radial-gradient(circle at top left, var(--google-blue), var(--google-green), var(--google-yellow), var(--google-red));
            background-origin: border-box;
            background-clip: padding-box, border-box;
            animation: bg-spin 3s linear infinite;
        }
        #searchMode {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #searchMode::before {
            content: 'IA';
            color: #000;
            font-size: 10px;
            font-weight: bold;
            position: absolute;
            left: 20px;
            top: 2px;
        }
        #searchMode::after {
            content: '';
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        #searchMode:checked {
            background-color: var(--google-blue);
        }
        #searchMode:checked::before {
            content: '';
        }
        #searchMode:checked::after {
            transform: translateX(20px);
        }

        /* --- PAINEL PRINCIPAL (KANBAN & LIST) --- */
        main {
            display: flex;
            gap: 15px;
            padding: 20px;
            min-height: calc(100vh - 100px);
            max-height: calc(100vh - 100px);
            align-items: flex-start;
        }

        .status-column {
            flex: 0 0 320px;
            background-color: var(--surface-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            border-top: 4px solid;
            transition: box-shadow 0.3s;
        }
        .status-column:hover {
            box-shadow: 0 0 20px -5px var(--border-color);
        }

        .column-header {
            padding: 10px 15px;
            font-weight: bold;
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-count {
            background-color: var(--surface-hover-color);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        #column-Aberto { border-color: var(--status-aberto); }
        #column-Andamento { border-color: var(--status-andamento); }
        #column-Finalizado { border-color: var(--status-finalizado); }
        #column-Aguardando { border-color: var(--status-aguardando); }

        .tickets-container {
            overflow-y: auto;
            flex-grow: 1;
            padding: 10px;
        }
        
        /* --- CARTÃO DE TICKET --- */
        .ticket-card {
            background-color: var(--surface-hover-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: fadeIn 0.5s ease;
        }
        .ticket-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        .ticket-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .ticket-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-status-select {
            background-color: var(--surface-color);
            color: var(--font-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 2px 5px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .card-status-select:hover {
            border-color: var(--primary-accent);
        }

        .ticket-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.8em;
            color: #aaa;
        }
        
        .footer-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .communication-status {
            display: flex;
            gap: 8px;
        }

        .comm-icon {
            background-color: var(--surface-hover-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .comm-icon:hover {
            transform: scale(1.1);
        }
        
        .ticket-id { font-size: 0.8em; color: #aaa; }
        .ticket-priority { padding: 3px 8px; border-radius: 10px; font-size: 0.8em; color: white; font-weight: bold; }
        .ticket-content { margin-bottom: 10px; }
        .ticket-content strong { font-size: 1.1em; }
        
        .deadline-wrapper {
            border: 2px solid transparent;
            padding: 2px 5px;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        .deadline-wrapper.alert {
            animation: pulse-border-red 1.5s infinite;
        }
        .deadline-wrapper.alert span {
            color: var(--priority-alta);
            font-weight: bold;
        }

        .ticket-requirements .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
            max-height: 50px; /* Altura inicial para 2 linhas de tags */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .ticket-requirements .tags-container.expanded {
            max-height: 500px; /* Altura máxima expandida */
        }
        .req-tag {
            background-color: var(--border-color);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            transition: background-color 0.2s, text-decoration 0.2s;
        }
        .req-tag.completed {
            text-decoration: line-through;
            background-color: #444;
            opacity: 0.7;
        }
        .toggle-reqs {
            background: none;
            border: none;
            color: var(--primary-accent);
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 5px;
            padding: 0;
            display: block;
            width: 100%;
            text-align: left;
        }

        /* --- ESTILOS PARA VISUALIZAÇÃO EM LISTA --- */
        main.list-view {
            flex-direction: column;
            align-items: stretch;
            position: relative;
            overflow-y: auto;
        }
        main.list-view .status-column {
            display: none;
        }

        .ticket-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--surface-hover-color);
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 5px solid;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            min-height: 70px;
            height: auto;
            box-sizing: border-box;
        }
        .ticket-row:hover {
            background-color: var(--surface-color);
            transform: translateY(-1px);
        }
        .ticket-row-main {
            flex-grow: 1;
            margin: 0 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 0; /* Fix para content overflow */
        }
        .ticket-row-main strong {
            font-size: 1.1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .ticket-row-end {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }
        .last-seen {
            color: #999;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 3px 7px;
            border-radius: 10px;
        }
        .last-seen svg {
            width: 15px;
            height: 15px;
            fill: #999;
        }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.8); animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: var(--surface-color); margin: 5% auto; padding: 25px; border: 1px solid var(--border-color);
            width: 90%; max-width: 700px; border-radius: 8px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.5);
        }
        .close-button {
            color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s;
        }
        .close-button:hover { color: white; }
        .modal-content h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-field { display: flex; flex-direction: column; }
        .form-field.full-width { grid-column: 1 / -1; }
        .form-field label { margin-bottom: 8px; font-size: 0.9em; color: #ccc; }
        .form-field input, .form-field select, .form-field textarea {
            width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color);
            color: var(--font-color); border-radius: 4px; box-sizing: border-box; transition: border-color 0.2s;
        }
        .form-field input:focus, .form-field select:focus, .form-field textarea:focus { outline: none; border-color: var(--primary-accent); }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        .form-buttons { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .form-buttons button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background-color: var(--primary-accent); color: white; }
        .btn-delete { background-color: var(--priority-alta); color: white; }
        .btn-cancel { background-color: var(--surface-hover-color); color: var(--font-color); }
        
        /* Histórico no Modal */
        .modal-extra-section {
            margin-top: 20px; max-height: 150px; overflow-y: auto; padding: 15px; background: var(--bg-color);
            border-radius: 4px; border: 1px solid var(--border-color);
        }
        .modal-extra-section h4 { margin: 0 0 10px 0; }
        .modal-extra-section ul { list-style: none; padding: 0; margin: 0; }
        .modal-extra-section li { font-size: 0.8em; color: #ccc; padding: 5px 0; border-bottom: 1px solid var(--border-color); }
        .modal-extra-section li:last-child { border-bottom: none; }

        /* Botão Adicionar Flutuante (FAB) */
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background-color: var(--primary-accent); color: white; border: none; border-radius: 50%;
            font-size: 30px; line-height: 60px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; z-index: 1001; transition: background-color 0.2s, transform 0.2s;
        }
        .fab:hover { background-color: var(--primary-accent-hover); transform: scale(1.05); }

        /* --- ANIMAÇÕES E RESPONSIVIDADE --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-border-red { 0% { border-color: var(--priority-alta); } 50% { border-color: transparent; } 100% { border-color: var(--priority-alta); } }
        @keyframes bg-spin { to { --border-angle: 360deg; } }
        @keyframes flash {
            0% { background-color: var(--primary-accent); }
            100% { background-color: var(--surface-hover-color); }
        }
        .flash {
            animation: flash 1s ease-out;
        }
        
        @property --border-angle { syntax: "<angle>"; inherits: true; initial-value: 0deg; }

        @media (max-width: 900px) {
            header { height: auto; padding: 10px; flex-wrap: wrap; justify-content: center; }
            .header-left, .header-right { width: 100%; justify-content: center; }
            body { padding-top: 120px; }
            main { flex-direction: column; }
            .status-column { flex: 1 1 auto; max-height: none; }
        }

    </style>
</head>
<body>

    <!-- CABEÇALHO FIXO -->
    <header>
        <div class="header-left">
            <div class="logo">To-do-ADM</div>
            <div class="dropdown">
                <button class="menu-button dropdown-toggle">Arquivo ▾</button>
                <div class="dropdown-content">
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <button id="importBtn" class="dropdown-item">Importar JSON...</button>
                    <select id="exportSelect" class="dropdown-item">
                        <option value="" disabled selected>Exportar como...</option>
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="menu-item">
                <label title="Ordenar por Prioridade" style="font-size: 1.5em; cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="prioritySortToggle" style="display: none;"> ⇅
                </label>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Buscar...">
                <input type="checkbox" id="searchMode" title="Ativar busca por IA">
            </div>
            <div class="menu-item">
                <select id="filterStatus">
                    <option value="">Todos Status</option>
                    <option value="Aberto">Aberto</option>
                    <option value="Andamento">Em Andamento</option>
                    <option value="Finalizado">Finalizado</option>
                    <option value="Aguardando">Aguardando</option>
                </select>
            </div>
            <div class="menu-item">
                <label style="font-size: 0.8em; margin-right: 5px; display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="showCompleted" checked> Mostrar Finalizados
                </label>
            </div>
            <div class="dropdown">
                <button id="notificationBtn" class="menu-button dropdown-toggle">
                    🔔
                    <span id="notification-count" style="display: none;">0</span>
                </button>
                <div id="notification-list" class="dropdown-content">
                    <!-- Notificações serão inseridas aqui -->
                </div>
            </div>
            <div class="dropdown">
                <button class="menu-button dropdown-toggle">⚙️</button>
                <div class="dropdown-content">
                    <button id="setApiKeyBtn" class="dropdown-item">Definir Chave de API</button>
                    <button id="autoBackupBtn" class="dropdown-item">Backup Automático...</button>
                </div>
            </div>
        </div>
    </header>

    <!-- PAINEL KANBAN -->
    <main id="kanbanBoard"></main>

    <!-- BOTÃO ADICIONAR FLUTUANTE -->
    <button id="addTicketFab" class="fab">+</button>

    <!-- MODAL PARA NOVO/EDITAR TICKET -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle">Novo Ticket</h2>
            <form id="ticketForm">
                <input type="hidden" id="ticketId">
                <div class="form-grid">
                    <div class="form-field full-width">
                        <label for="ticketTitle">Título do Ticket</label>
                        <input type="text" id="ticketTitle" required>
                    </div>
                    <div class="form-field">
                        <label for="ticketStatus">Status</label>
                        <select id="ticketStatus" required></select>
                    </div>
                     <div class="form-field">
                        <label for="ticketPriority">Prioridade</label>
                        <select id="ticketPriority" required>
                            <option value="Baixa">Baixa</option>
                            <option value="Media">Média</option>
                            <option value="Alta">Alta</option>
                        </select>
                    </div>
                     <div class="form-field">
                        <label for="ticketStartDate">Data de Início</label>
                        <input type="date" id="ticketStartDate" required>
                    </div>
                    <div class="form-field">
                        <label for="ticketDeadline">Prazo Final</label>
                        <input type="date" id="ticketDeadline" required>
                    </div>
                    <div class="form-field full-width">
                        <label for="ticketRequirements">Requerimento (tags separadas por vírgula)</label>
                        <textarea id="ticketRequirements" rows="3"></textarea>
                    </div>
                    <div class="form-field full-width">
                        <label>Status de Comunicação</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="ticketAviseiRegiana"> Avisei a Regiana</label>
                            <label><input type="checkbox" id="ticketComuniqueiAluno"> Comuniquei o aluno</label>
                            <label><input type="checkbox" id="ticketAguardandoRetorno"> Aguardando retorno do aluno</label>
                        </div>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="button" id="deleteTicketBtn" class="btn-delete" style="display:none;">Excluir</button>
                    <button type="button" class="btn-cancel">Cancelar</button>
                    <button type="submit" class="btn-save">Salvar</button>
                </div>
            </form>
            <div id="ticket-history" class="modal-extra-section" style="display:none;">
                <h4>Histórico de Alterações</h4>
                <ul id="history-list"></ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIÁVEIS E CONSTANTES GLOBAIS ---
            const kanbanBoard = document.getElementById('kanbanBoard');
            const ticketForm = document.getElementById('ticketForm');
            const searchInput = document.getElementById('searchInput');
            const searchMode = document.getElementById('searchMode');
            const filterStatus = document.getElementById('filterStatus');
            const addTicketFab = document.getElementById('addTicketFab');
            const showCompletedCheckbox = document.getElementById('showCompleted');
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');
            const prioritySortToggle = document.getElementById('prioritySortToggle');

            let tickets = [];
            let googleApiKey = '';
            let editCount = 0;
            let autoBackupCount = 5; // Default
            const statuses = ['Aberto', 'Andamento', 'Aguardando', 'Finalizado'];
            const statusColors = {
                Aberto: 'var(--status-aberto)', Andamento: 'var(--status-andamento)',
                Finalizado: 'var(--status-finalizado)', Aguardando: 'var(--status-aguardando)',
            };
            const priorityColors = {
                Alta: 'var(--priority-alta)', Media: 'var(--priority-media)', Baixa: 'var(--priority-baixa)',
            };

            // --- FUNÇÕES DE LÓGICA DE DADOS ---
            const loadData = () => {
                const data = localStorage.getItem('todo-adm-tickets-v8');
                googleApiKey = localStorage.getItem('todo-adm-google-api-key') || '';
                autoBackupCount = parseInt(localStorage.getItem('todo-adm-autobackup-count') || '5', 10);
                editCount = parseInt(localStorage.getItem('todo-adm-edit-count') || '0', 10);
                tickets = data ? JSON.parse(data) : [];
                migrateTagsDataStructure();
                renderNotifications();
            };

            const migrateTagsDataStructure = () => {
                let needsSave = false;
                tickets.forEach(ticket => {
                    if (ticket.requirements && typeof ticket.requirements === 'string') {
                        needsSave = true;
                        ticket.requirements = ticket.requirements.split(',')
                            .map(name => name.trim())
                            .filter(name => name)
                            .map(name => ({ name: name, completed: false }));
                    } else if (!ticket.requirements) {
                        ticket.requirements = [];
                    }
                });
                if (needsSave) {
                    saveData(false); // Save without incrementing edit count
                }
            };

            const saveData = (trackEdit = true) => {
                localStorage.setItem('todo-adm-tickets-v8', JSON.stringify(tickets));
                renderNotifications();

                if (trackEdit && autoBackupCount > 0) {
                    editCount++;
                    localStorage.setItem('todo-adm-edit-count', editCount.toString());
                    if (editCount >= autoBackupCount) {
                        handleAutoBackup();
                        editCount = 0; 
                        localStorage.setItem('todo-adm-edit-count', '0');
                    }
                }
            };
            
            const addLogEntry = (ticket, action, user = "Usuário") => {
                if (!ticket.history) ticket.history = [];
                ticket.history.unshift({ action, user, timestamp: new Date().toISOString() });
                if (ticket.history.length > 20) ticket.history.pop();
            };

            // --- RENDERIZAÇÃO DA UI ---
            const renderBoard = async () => {
                const filteredTickets = await getFilteredTickets();
                const statusFilter = filterStatus.value;
                kanbanBoard.innerHTML = ''; // Limpa o painel primeiro
                kanbanBoard.onscroll = null; // Limpa o listener de scroll anterior

                if (statusFilter && statusFilter !== '') {
                    renderListView(filteredTickets);
                } else {
                    renderKanbanView(filteredTickets);
                }
                setupDragAndDrop();
            };

            const renderKanbanView = (filteredTickets) => {
                kanbanBoard.classList.remove('list-view');
                if (filteredTickets.length === 0 && tickets.length > 0) {
                    kanbanBoard.innerHTML = '<p style="padding: 20px; color: #aaa;">Nenhum ticket encontrado com os filtros atuais.</p>';
                }
                
                statuses.forEach(status => {
                    if (!showCompletedCheckbox.checked && status === 'Finalizado') return;
                    
                    const column = document.createElement('div');
                    column.className = 'status-column';
                    column.id = `column-${status.replace(/\s+/g, '')}`;
                    column.dataset.status = status;
                    column.style.borderColor = statusColors[status];

                    const ticketsInColumn = filteredTickets.filter(t => t.status === status);

                    if (prioritySortToggle.checked) {
                        const priorityOrder = { 'Alta': 0, 'Media': 1, 'Baixa': 2 };
                        ticketsInColumn.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
                    }

                    column.innerHTML = `
                        <div class="column-header">
                            <span>${status}</span>
                            <span class="ticket-count">${ticketsInColumn.length}</span>
                        </div>
                        <div class="tickets-container"></div>
                    `;
                    kanbanBoard.appendChild(column);
                    
                    const ticketsContainer = column.querySelector('.tickets-container');
                    ticketsInColumn.forEach(ticket => {
                        const ticketCard = createTicketCard(ticket);
                        ticketsContainer.appendChild(ticketCard);
                    });
                });
            };

            const renderListView = (filteredTickets) => {
                kanbanBoard.classList.add('list-view');
                if (filteredTickets.length === 0) {
                    kanbanBoard.innerHTML = '<p style="padding: 20px; color: #aaa;">Nenhum ticket encontrado com o status selecionado.</p>';
                    return;
                }
                if (prioritySortToggle.checked) {
                    const priorityOrder = { 'Alta': 0, 'Media': 1, 'Baixa': 2 };
                    filteredTickets.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
                }

                // Simple render loop, no virtual scrolling
                filteredTickets.forEach(ticket => {
                    const ticketRow = createTicketRow(ticket);
                    kanbanBoard.appendChild(ticketRow);
                });
            };

            const createRequirementsHTML = (requirements, tagLimit = 3) => {
                if (!requirements || requirements.length === 0) return '';

                // Sort tags: completed ones go to the end
                const sortedReqs = [...requirements].sort((a, b) => a.completed - b.completed);

                const tagsHTML = sortedReqs.map(req => 
                    `<span class="req-tag ${req.completed ? 'completed' : ''}" data-tag-name="${req.name}">${req.name}</span>`
                ).join('');

                return `
                    <div class="ticket-requirements">
                        <div class="tags-container">
                            ${tagsHTML}
                        </div>
                        ${sortedReqs.length > tagLimit ? '<button class="toggle-reqs">Mostrar mais...</button>' : ''}
                    </div>
                `;
            };
            
            const createTicketCard = (ticket) => {
                const card = document.createElement('div');
                card.className = 'ticket-card';
                card.draggable = true;
                card.dataset.id = ticket.id;
                card.style.borderColor = statusColors[ticket.status];

                const now = new Date();
                const deadline = new Date(ticket.deadline);
                const isOverdue = deadline < now && ticket.status !== 'Finalizado';
                const nearingDeadline = !isOverdue && (deadline - now) / (1000 * 3600) <= 24 && ticket.status !== 'Finalizado';
                
                let communicationHTML = '';
                if (ticket.aviseiRegiana || ticket.comuniqueiAluno || ticket.aguardandoRetorno) {
                    communicationHTML += '<div class="communication-status">';
                    if (ticket.aviseiRegiana) communicationHTML += '<span class="comm-icon" title="Regiana foi avisada">R</span>';
                    if (ticket.comuniqueiAluno) communicationHTML += '<span class="comm-icon" title="Aluno comunicado">A</span>';
                    if (ticket.aguardandoRetorno) communicationHTML += '<span class="comm-icon" title="Aguardando retorno do aluno">⏳</span>';
                    communicationHTML += '</div>';
                }

                card.innerHTML = `
                    <div class="ticket-header">
                        <span class="ticket-id">#${ticket.id.toString().substring(0, 6)}</span>
                        <div class="ticket-header-right">
                            <select data-id="${ticket.id}" class="card-status-select">
                                ${statuses.map(s => `<option value="${s}" ${s === ticket.status ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            <span class="ticket-priority" style="background-color: ${priorityColors[ticket.priority]}">${ticket.priority}</span>
                        </div>
                    </div>
                    <div class="ticket-content">
                        <strong>${ticket.title}</strong>
                        ${createRequirementsHTML(ticket.requirements, 2)}
                    </div>
                    <div class="ticket-footer">
                        <div class="footer-left">
                           ${communicationHTML}
                           <span class="last-seen">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>
                                <span class="last-seen-text">${formatTimeAgo(ticket.lastSeen)}</span>
                           </span>
                        </div>
                        <div class="deadline-wrapper ${isOverdue || nearingDeadline ? 'alert' : ''}">
                            <span>Prazo: ${new Date(ticket.deadline).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
                
                card.querySelector('.card-status-select').addEventListener('click', (e) => e.stopPropagation());
                card.querySelector('.card-status-select').addEventListener('change', handleQuickStatusChange);

                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-reqs')) {
                         e.stopPropagation();
                         const container = e.target.previousElementSibling;
                         container.classList.toggle('expanded');
                         e.target.textContent = container.classList.contains('expanded') ? 'Mostrar menos' : 'Mostrar mais...';
                    } else if (e.target.classList.contains('req-tag')) {
                        e.stopPropagation();
                        handleTagClick(ticket.id, e.target.dataset.tagName);
                    } else {
                        handleMarkAsSeen(ticket.id);
                        openModal('ticketModal', ticket.id);
                    }
                });

                return card;
            };

            const createTicketRow = (ticket) => {
                const row = document.createElement('div');
                row.className = 'ticket-row';
                row.dataset.id = ticket.id;
                row.style.borderColor = statusColors[ticket.status];

                const now = new Date();
                const deadline = new Date(ticket.deadline);
                const isOverdue = deadline < now && ticket.status !== 'Finalizado';
                
                let communicationHTML = '';
                if (ticket.aviseiRegiana || ticket.comuniqueiAluno || ticket.aguardandoRetorno) {
                    communicationHTML += '<div class="communication-status">';
                    if (ticket.aviseiRegiana) communicationHTML += '<span class="comm-icon" title="Regiana foi avisada">R</span>';
                    if (ticket.comuniqueiAluno) communicationHTML += '<span class="comm-icon" title="Aluno comunicado">A</span>';
                    if (ticket.aguardandoRetorno) communicationHTML += '<span class="comm-icon" title="Aguardando retorno do aluno">⏳</span>';
                    communicationHTML += '</div>';
                }
                
                row.innerHTML = `
                    <span class="ticket-id">#${ticket.id.toString().substring(0, 6)}</span>
                    <div class="ticket-row-main">
                        <strong>${ticket.title}</strong>
                        ${createRequirementsHTML(ticket.requirements, 3)}
                    </div>
                    <div class="ticket-row-end">
                        ${communicationHTML}
                        <span class="last-seen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>
                            <span class="last-seen-text">${formatTimeAgo(ticket.lastSeen)}</span>
                        </span>
                        <span class="ticket-priority" style="background-color: ${priorityColors[ticket.priority]}">${ticket.priority}</span>
                        <div class="deadline-wrapper ${isOverdue ? 'alert' : ''}">
                            <span>Prazo: ${new Date(ticket.deadline).toLocaleDateString()}</span>
                        </div>
                        <select data-id="${ticket.id}" class="card-status-select">
                            ${statuses.map(s => `<option value="${s}" ${s === ticket.status ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                `;
                
                row.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-reqs')) {
                         e.stopPropagation();
                         const container = e.target.previousElementSibling;
                         container.classList.toggle('expanded');
                         e.target.textContent = container.classList.contains('expanded') ? 'Mostrar menos' : 'Mostrar mais...';
                    } else if (e.target.classList.contains('req-tag')) {
                        e.stopPropagation();
                        handleTagClick(ticket.id, e.target.dataset.tagName);
                    } else if (e.target.tagName.toLowerCase() !== 'select') {
                        handleMarkAsSeen(ticket.id);
                        openModal('ticketModal', ticket.id);
                    }
                });
                
                const statusSelect = row.querySelector('.card-status-select');
                statusSelect.addEventListener('change', handleQuickStatusChange);
                statusSelect.addEventListener('click', (e) => e.stopPropagation());

                return row;
            };

            const getFilteredTickets = async () => {
                const searchTerm = searchInput.value.toLowerCase();
                const statusFilter = filterStatus.value;
                
                let baseTickets = tickets;

                if (searchMode.checked && searchTerm) {
                    searchInput.disabled = true;
                    searchInput.placeholder = 'Pesquisando com IA...';
                    try {
                        const aiFilteredIds = await performAISearch(searchTerm);
                        baseTickets = tickets.filter(t => aiFilteredIds.includes(t.id));
                    } catch (error) {
                        alert(`Erro na busca com IA: ${error.message}`);
                        baseTickets = tickets.filter(ticket => 
                            (ticket.title && ticket.title.toLowerCase().includes(searchTerm)) ||
                            (ticket.requirements && ticket.requirements.some(r => r.name.toLowerCase().includes(searchTerm)))
                        );
                    } finally {
                        searchInput.disabled = false;
                        searchInput.placeholder = 'Buscar...';
                    }
                } else if (searchTerm) {
                    baseTickets = tickets.filter(ticket => 
                        (ticket.title && ticket.title.toLowerCase().includes(searchTerm)) ||
                        (ticket.requirements && ticket.requirements.some(r => r.name.toLowerCase().includes(searchTerm)))
                    );
                }

                return baseTickets.filter(ticket => {
                    const matchesStatus = statusFilter === '' || ticket.status === statusFilter;
                    const matchesCompleted = showCompletedCheckbox.checked || ticket.status !== 'Finalizado';
                    return matchesStatus && matchesCompleted;
                });
            };

            // --- LÓGICA DE IA ---
            const performAISearch = async (query) => {
                if (!googleApiKey) throw new Error("Chave de API do Google não definida. Por favor, defina nas configurações.");
                
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${googleApiKey}`;
                
                let ticketsToSearch = showCompletedCheckbox.checked ? tickets : tickets.filter(t => t.status !== 'Finalizado');
                const simplifiedTickets = ticketsToSearch.map(({ id, title, requirements, priority, deadline }) => ({ 
                    id, 
                    title, 
                    requirements: requirements.map(r => r.name).join(', '), 
                    priority, 
                    deadline 
                }));

                const prompt = `Você é um assistente de kanban. Analise as tarefas JSON. A data atual é ${new Date().toLocaleDateString()}. Pesquisa do usuário: "${query}". Retorne um array JSON com os IDs das tarefas mais relevantes. Lista: ${JSON.stringify(simplifiedTickets)}. Responda apenas com o array de IDs.`;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { response_mime_type: "application/json" } })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message || "Erro na API do Google.");
                }

                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            };

            // --- NOTIFICAÇÕES ---
            const renderNotifications = () => {
                notificationList.innerHTML = '';
                const now = new Date();
                let count = 0;

                const urgentTickets = tickets.filter(ticket => {
                    if (ticket.status === 'Finalizado') return false;
                    const deadline = new Date(ticket.deadline);
                    const hoursRemaining = (deadline - now) / (1000 * 3600);
                    return hoursRemaining <= 24;
                });

                if (urgentTickets.length === 0) {
                    notificationList.innerHTML = '<div class="notification-item"><p>Nenhuma notificação</p></div>';
                    notificationCount.style.display = 'none';
                    return;
                }

                urgentTickets.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

                urgentTickets.forEach(ticket => {
                    const deadline = new Date(ticket.deadline);
                    const isOverdue = deadline < now;
                    const message = isOverdue ? 'Ticket Atrasado!' : 'Vence em menos de 24h!';
                    
                    const item = document.createElement('div');
                    item.className = 'notification-item';
                    item.dataset.ticketId = ticket.id;
                    item.innerHTML = `
                        <div class="notification-info">
                            <p><strong>${ticket.title}</strong></p>
                            <small style="color: ${isOverdue ? 'var(--priority-alta)' : 'var(--status-aberto)'}">${message}</small>
                        </div>
                        <select data-id="${ticket.id}" class="card-status-select">
                            ${statuses.map(s => `<option value="${s}" ${s === ticket.status ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    `;
                    notificationList.appendChild(item);
                });

                count = urgentTickets.length;
                notificationCount.textContent = count;
                notificationCount.style.display = count > 0 ? 'flex' : 'none';
            };

            const requestNotificationPermission = () => {
                if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            };

            const checkDeadlinesForDesktop = () => {
                const now = new Date();
                tickets.forEach(ticket => {
                    if (ticket.status === 'Finalizado') return;
                    const deadline = new Date(ticket.deadline);
                    const hoursRemaining = (deadline - now) / (1000 * 3600);
                    if (hoursRemaining > 0 && hoursRemaining <= 24) {
                        showDesktopNotification(`Ticket próximo do prazo: "${ticket.title}"`, `O prazo termina em menos de 24 horas.`);
                    }
                });
            };

            const showDesktopNotification = (title, body) => {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body });
                }
            };

            // --- MODAL E FORMULÁRIOS ---
            const openModal = (modalId, ticketId = null) => {
                const modal = document.getElementById(modalId);
                if (modalId === 'ticketModal') setupTicketModal(ticketId);
                modal.style.display = 'block';
            };

            const closeModal = (modalId) => document.getElementById(modalId).style.display = 'none';

            const setupTicketModal = (ticketId) => {
                ticketForm.reset();
                document.getElementById('ticket-history').style.display = 'none';
                document.getElementById('ticketStatus').innerHTML = statuses.map(s => `<option value="${s}">${s}</option>`).join('');

                if (ticketId) {
                    const ticket = tickets.find(t => t.id === ticketId);
                    document.getElementById('modalTitle').textContent = 'Editar Ticket';
                    
                    document.getElementById('ticketId').value = ticket.id;
                    document.getElementById('ticketTitle').value = ticket.title;
                    document.getElementById('ticketStatus').value = ticket.status;
                    document.getElementById('ticketPriority').value = ticket.priority;
                    document.getElementById('ticketStartDate').value = ticket.startDate;
                    document.getElementById('ticketDeadline').value = ticket.deadline;
                    document.getElementById('ticketAviseiRegiana').checked = ticket.aviseiRegiana;
                    document.getElementById('ticketComuniqueiAluno').checked = ticket.comuniqueiAluno;
                    document.getElementById('ticketAguardandoRetorno').checked = ticket.aguardandoRetorno;
                    
                    let reqValue = '';
                    if (Array.isArray(ticket.requirements)) {
                        reqValue = ticket.requirements.map(r => r.name).join(', ');
                    } else if (typeof ticket.requirements === 'string') {
                        reqValue = ticket.requirements;
                    }
                    document.getElementById('ticketRequirements').value = reqValue;

                    if (ticket.history?.length > 0) renderHistoryInModal(ticket.history);
                    document.getElementById('deleteTicketBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('modalTitle').textContent = 'Novo Ticket';
                    document.getElementById('ticketId').value = '';
                    document.getElementById('ticketStartDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('deleteTicketBtn').style.display = 'none';
                }
            };
            
            const renderHistoryInModal = (history) => {
                const historyContainer = document.getElementById('ticket-history');
                historyContainer.style.display = 'block';
                document.getElementById('history-list').innerHTML = history.map(log => 
                    `<li>${new Date(log.timestamp).toLocaleString()}: ${log.action} (por ${log.user})</li>`
                ).join('');
            };

            // --- HANDLERS DE EVENTOS ---
            const handleFormSubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('ticketId').value;
                const originalTicket = id ? { ...tickets.find(t => t.id === id) } : null;
                
                const newReqsString = document.getElementById('ticketRequirements').value.trim();
                const newReqsNames = newReqsString.split(',').map(name => name.trim()).filter(name => name);
                
                const newRequirements = newReqsNames.map(name => {
                    const existingReq = originalTicket?.requirements.find(r => r.name === name);
                    return { name: name, completed: existingReq ? existingReq.completed : false };
                });

                const ticketData = {
                    id: id || Date.now().toString(),
                    title: document.getElementById('ticketTitle').value.trim(),
                    status: document.getElementById('ticketStatus').value,
                    startDate: document.getElementById('ticketStartDate').value,
                    deadline: document.getElementById('ticketDeadline').value,
                    priority: document.getElementById('ticketPriority').value,
                    requirements: newRequirements,
                    aviseiRegiana: document.getElementById('ticketAviseiRegiana').checked,
                    comuniqueiAluno: document.getElementById('ticketComuniqueiAluno').checked,
                    aguardandoRetorno: document.getElementById('ticketAguardandoRetorno').checked,
                    history: originalTicket?.history || [],
                    lastSeen: new Date().toISOString() // Update on save
                };

                if (id) {
                    const index = tickets.findIndex(t => t.id === id);
                    const changes = getChanges(originalTicket, ticketData);
                    if (changes) addLogEntry(ticketData, `Ticket editado: ${changes}`);
                    tickets[index] = ticketData;
                } else {
                    addLogEntry(ticketData, 'Ticket criado.');
                    tickets.push(ticketData);
                }
                saveData();
                renderBoard();
                closeModal('ticketModal');
            };
            
            const getChanges = (oldT, newT) => Object.keys(newT).filter(key => key !== 'history' && JSON.stringify(oldT[key]) !== JSON.stringify(newT[key])).map(key => `${key} alterado`).join(', ');

            const handleDeleteTicket = () => {
                if (confirm('Tem certeza que deseja excluir este ticket?')) {
                    const id = document.getElementById('ticketId').value;
                    tickets = tickets.filter(t => t.id !== id);
                    saveData();
                    renderBoard();
                    closeModal('ticketModal');
                }
            };
            
            const handleSetApiKey = () => {
                const key = prompt("Insira sua chave de API do Google AI Studio:", googleApiKey);
                if (key !== null) {
                    googleApiKey = key.trim();
                    localStorage.setItem('todo-adm-google-api-key', googleApiKey);
                    alert("Chave de API salva com sucesso!");
                }
            };

            const handleQuickStatusChange = (e) => {
                e.stopPropagation();
                const ticketId = e.target.dataset.id;
                const newStatus = e.target.value;
                const ticketToUpdate = tickets.find(t => t.id === ticketId);

                if (ticketToUpdate && ticketToUpdate.status !== newStatus) {
                    addLogEntry(ticketToUpdate, `Status alterado de "${ticketToUpdate.status}" para "${newStatus}"`);
                    ticketToUpdate.status = newStatus;
                    updateLastSeenTimestamp(ticketToUpdate);
                    saveData();
                    renderBoard();
                }
            };

            const handleTagClick = (ticketId, tagName) => {
                const ticket = tickets.find(t => t.id === ticketId);
                if (!ticket) return;

                const tag = ticket.requirements.find(r => r.name === tagName);
                if (!tag) return;

                tag.completed = !tag.completed;
                addLogEntry(ticket, `Tag "${tagName}" marcada como ${tag.completed ? 'concluída' : 'pendente'}.`);
                updateLastSeenTimestamp(ticket);
                saveData();

                const currentElement = document.querySelector(`.ticket-card[data-id="${ticketId}"], .ticket-row[data-id="${ticketId}"]`);
                if (currentElement) {
                    let newElement;
                    if (currentElement.classList.contains('ticket-card')) {
                        newElement = createTicketCard(ticket);
                    } else {
                        newElement = createTicketRow(ticket);
                    }
                    currentElement.replaceWith(newElement);
                } else {
                    renderBoard();
                }
            };

            const handleMarkAsSeen = (ticketId) => {
                const ticket = tickets.find(t => t.id === ticketId);
                if (ticket) {
                    updateLastSeenTimestamp(ticket);
                    saveData();
                    const currentElement = document.querySelector(`.ticket-card[data-id="${ticketId}"], .ticket-row[data-id="${ticketId}"]`);
                    if (currentElement) {
                        const lastSeenEl = currentElement.querySelector('.last-seen-text');
                        if (lastSeenEl) {
                            lastSeenEl.textContent = formatTimeAgo(ticket.lastSeen);
                        }
                    }
                }
            };
            
            const updateLastSeenTimestamp = (ticket) => {
                if (ticket) {
                    ticket.lastSeen = new Date().toISOString();
                }
            };

            // --- DRAG & DROP, IMPORT/EXPORT, BACKUP ---
            const setupDragAndDrop = () => {
                if (kanbanBoard.classList.contains('list-view')) {
                    return;
                }
                document.querySelectorAll('.ticket-card').forEach(card => {
                    card.addEventListener('dragstart', e => e.target.classList.add('dragging'));
                    card.addEventListener('dragend', e => e.target.classList.remove('dragging'));
                });
                document.querySelectorAll('.status-column').forEach(column => {
                    column.addEventListener('dragover', e => { e.preventDefault(); });
                    column.addEventListener('drop', e => {
                        e.preventDefault();
                        const cardId = document.querySelector('.dragging')?.dataset.id;
                        if (!cardId) return;
                        const ticket = tickets.find(t => t.id === cardId);
                        const newStatus = column.dataset.status;
                        if (ticket.status !== newStatus) {
                            addLogEntry(ticket, `Status movido de "${ticket.status}" para "${newStatus}"`);
                            ticket.status = newStatus;
                            updateLastSeenTimestamp(ticket);
                            saveData();
                            renderBoard();
                        }
                    });
                });
            };

            const handleExport = (format) => {
                if (tickets.length === 0) return alert('Nenhum ticket para exportar.');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `todo-adm-backup-${timestamp}.${format}`;
                let content, mimeType;

                if (format === 'json') {
                    content = JSON.stringify(tickets, null, 2);
                    mimeType = 'application/json';
                } else if (format === 'csv') {
                    const headers = Object.keys(tickets[0] || {}).join(',');
                    const rows = tickets.map(t => {
                        return Object.values(t).map(val => {
                            let value = '';
                            if (typeof val === 'string') {
                                value = val.replace(/"/g, '""');
                            } else if (typeof val === 'object' && val !== null) {
                                value = JSON.stringify(val).replace(/"/g, '""');
                            } else {
                                value = String(val);
                            }
                            return `"${value}"`;
                        }).join(',');
                    });
                    content = `${headers}\n${rows.join('\n')}`;
                    mimeType = 'text/csv;charset=utf-8;';
                }
                if (content) {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([content], { type: mimeType }));
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                }
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        if (!file.name.endsWith('.json')) {
                            throw new Error('Formato de arquivo não suportado. Use JSON.');
                        }
                        const importedTickets = JSON.parse(e.target.result);
                        if (!Array.isArray(importedTickets)) throw new Error('O arquivo JSON não contém um array de tickets válido.');
                        
                        importedTickets.forEach(ticket => {
                            if (ticket.requirements && typeof ticket.requirements === 'string') {
                                ticket.requirements = ticket.requirements.split(',')
                                    .map(name => name.trim())
                                    .filter(name => name)
                                    .map(name => ({ name: name, completed: false }));
                            } else if (!ticket.requirements) {
                                ticket.requirements = [];
                            }
                        });

                        const merge = confirm('Deseja mesclar com os tickets existentes? "Cancelar" irá substituir.');
                        if (merge) {
                            const existingIds = new Set(tickets.map(t => t.id));
                            tickets.push(...importedTickets.filter(t => !existingIds.has(t.id)));
                        } else {
                            tickets = importedTickets;
                        }
                        saveData();
                        renderBoard();
                        alert('Dados importados com sucesso!');
                    } catch (error) {
                        alert('Erro ao importar arquivo: ' + error.message);
                    } finally {
                        event.target.value = ''; // Limpa o input
                    }
                };
                reader.readAsText(file);
            };

            const handleAutoBackup = () => {
                if (tickets.length === 0) return; 

                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const filename = `Backup-${hours}${minutes}.json`;

                const content = JSON.stringify(tickets, null, 2);
                const mimeType = 'application/json';

                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([content], { type: mimeType }));
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            };

            const handleAutoBackupSettings = () => {
                const currentSetting = autoBackupCount > 0 ? autoBackupCount : 'desativado';
                const newCountStr = prompt(`A cada quantas edições o backup automático deve ser feito?\n(Atual: ${currentSetting}).\nDigite um número (ex: 5) ou 0 para desativar.`, autoBackupCount);

                if (newCountStr !== null) {
                    const newCount = parseInt(newCountStr, 10);
                    if (!isNaN(newCount) && newCount >= 0) {
                        autoBackupCount = newCount;
                        localStorage.setItem('todo-adm-autobackup-count', autoBackupCount.toString());
                        editCount = 0;
                        localStorage.setItem('todo-adm-edit-count', '0');
                        alert(autoBackupCount > 0 ? `Backup automático configurado para cada ${autoBackupCount} edições.` : 'Backup automático desativado.');
                    } else {
                        alert('Por favor, insira um número válido.');
                    }
                }
            };

            const formatTimeAgo = (isoString) => {
                if (!isoString) return '';
                const now = new Date();
                const seenDate = new Date(isoString);
                const diffSeconds = (now - seenDate) / 1000;
                const diffMinutes = diffSeconds / 60;
                const diffHours = diffMinutes / 60;
                const diffDays = Math.floor(diffHours / 24);

                if (diffMinutes < 1) return 'agora';
                if (diffMinutes < 60) return `há ${Math.round(diffMinutes)} min`;
                if (diffHours < 6) return `há ${Math.round(diffHours)}h`;

                const isToday = now.toDateString() === seenDate.toDateString();
                if (isToday) {
                    const seenHour = seenDate.getHours();
                    if (seenHour < 12) return 'hoje de manhã';
                    if (seenHour < 18) return 'hoje à tarde';
                    return 'hoje à noite';
                }

                const yesterday = new Date();
                yesterday.setDate(now.getDate() - 1);
                if (yesterday.toDateString() === seenDate.toDateString()) {
                    return 'ontem';
                }

                return `há ${diffDays} dias`;
            };

            const updateAllVisibleTimestamps = () => {
                document.querySelectorAll('.ticket-card[data-id], .ticket-row[data-id]').forEach(el => {
                    const ticket = tickets.find(t => t.id === el.dataset.id);
                    if (ticket && ticket.lastSeen) {
                        const lastSeenEl = el.querySelector('.last-seen-text');
                        if (lastSeenEl) {
                            lastSeenEl.textContent = formatTimeAgo(ticket.lastSeen);
                        }
                    }
                });
            };

            // --- INICIALIZAÇÃO E LISTENERS ---
            addTicketFab.addEventListener('click', () => openModal('ticketModal'));
            document.querySelector('#ticketModal .close-button').addEventListener('click', () => closeModal('ticketModal'));
            document.querySelector('#ticketModal .btn-cancel').addEventListener('click', () => closeModal('ticketModal'));
            ticketForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('deleteTicketBtn').addEventListener('click', handleDeleteTicket);
            document.getElementById('setApiKeyBtn').addEventListener('click', handleSetApiKey);
            document.getElementById('autoBackupBtn').addEventListener('click', handleAutoBackupSettings);


            document.querySelectorAll('.dropdown-toggle').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const dropdown = btn.nextElementSibling;
                    document.querySelectorAll('.dropdown-content').forEach(d => {
                        if (d !== dropdown) d.classList.remove('show');
                    });
                    dropdown.classList.toggle('show');
                });
            });
            
            window.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
                }
            });
            
            notificationList.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('.notification-item') && !target.matches('select')) {
                    const ticketId = target.closest('.notification-item').dataset.ticketId;
                    const card = document.querySelector(`.ticket-card[data-id="${ticketId}"]`);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.classList.add('flash');
                        setTimeout(() => card.classList.remove('flash'), 1000);
                    }
                    notificationList.classList.remove('show');
                }
            });
            notificationList.addEventListener('change', handleQuickStatusChange);


            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
            document.getElementById('importFile').addEventListener('change', handleImport);
            document.getElementById('exportSelect').addEventListener('change', e => { if (e.target.value) { handleExport(e.target.value); e.target.value = ''; } });

            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(renderBoard, 500); // Debounce para evitar buscas excessivas
            });
            searchMode.addEventListener('change', () => searchInput.classList.toggle('ai-active', searchMode.checked));
            filterStatus.addEventListener('change', renderBoard);
            showCompletedCheckbox.addEventListener('change', renderBoard);
            prioritySortToggle.addEventListener('change', renderBoard);

            loadData();
            renderBoard();
            requestNotificationPermission();
            setInterval(checkDeadlinesForDesktop, 60 * 1000 * 5); // Verifica prazos a cada 5 minutos
            setInterval(updateAllVisibleTimestamps, 60000); // Atualiza os tempos a cada minuto
        });
    </script>
</body>
</html>
